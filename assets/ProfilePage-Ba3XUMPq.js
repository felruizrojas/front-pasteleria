import{a as Q,r as d,f as C,g as H,h as J,j as e,c as R,s as W}from"./index-CtA74-58.js";import{B as U,I as y}from"./Input-CJ-O810F.js";import{u as X}from"./useAuth-CsPYcmks.js";import{v as Z,m as ee,a as ae,s as se}from"./userValidations-DoQ_YzLs.js";const re=o=>{const l=o.replace(/[^0-9kK]/g,"").toUpperCase();return l?l.length===1?{body:"",digit:l}:{body:l.slice(0,-1).slice(0,8),digit:l.slice(-1)}:{body:"",digit:""}},A=o=>{const{body:l,digit:h}=re(o?.run??"");return{id:o?.id??"",run:l&&h?`${l}${h}`:"",runBody:l,runDigit:h,nombre:o?.nombre??"",apellidos:o?.apellidos??"",correo:o?.correo??"",fechaNacimiento:o?.fechaNacimiento??"",regionId:o?.regionId??"",comuna:o?.comuna??"",direccion:o?.direccion??"",password:"",confirmPassword:"",termsAccepted:!0,avatarUrl:o?.avatarUrl??C,codigoDescuento:o?.codigoDescuento??""}},ne=o=>{if(!o)return null;const l=new Date(o);if(Number.isNaN(l.getTime()))return null;const h=new Date;let w=h.getFullYear()-l.getFullYear();const f=h.getMonth()-l.getMonth();return(f<0||f===0&&h.getDate()<l.getDate())&&(w-=1),w},ce=()=>{const o=Q(),{logout:l,refreshUser:h}=X(),[w,f]=d.useState(C),[T,$]=d.useState([]),[u,E]=d.useState(null),[s,v]=d.useState(A()),[r,I]=d.useState({}),[B,p]=d.useState({}),[k,x]=d.useState(null),j=u?.tipoUsuario==="SuperAdmin",[z,F]=d.useState(!1),L=d.useMemo(()=>{const a=[],t=s.fechaNacimiento||u?.fechaNacimiento,n=ne(t),i=(u?.codigoDescuento??s.codigoDescuento??"").trim().toUpperCase(),m=(s.correo||u?.correo||"").toLowerCase().split("@")[1]??"";return typeof n=="number"&&n>=50&&a.push({id:"senior-discount",text:"Obtienes un 50% de descuento por ser mayor de 50 años."}),i==="FELICES50"&&a.push({id:"felices50",text:"Aplicamos un 10% de descuento gracias al código FELICES50."}),m==="duoc.cl"&&a.push({id:"duoc-birthday",text:"Tienes derecho a una torta gratis en tu cumpleaños por pertenecer a la comunidad Duoc UC."}),a},[u?.codigoDescuento,u?.correo,u?.fechaNacimiento,s.codigoDescuento,s.correo,s.fechaNacimiento]),D=d.useCallback((a,t,n)=>{const i=n??Z(a,{mode:"update"}),c={};return Object.keys(t).forEach(m=>{if(!t[m])return;const N=i.errors[m];N&&(c[m]=N)}),I(c),i},[I]),S=d.useMemo(()=>{const a=u?.tipoUsuario;return a==="Administrador"||a==="SuperAdmin"?{label:"Ir a la vista de administrador",to:"/admin",icon:"bi-speedometer2"}:a==="Vendedor"?{label:"Ir a la vista de vendedor",to:"/seller",icon:"bi-shop"}:null},[u?.tipoUsuario]);d.useEffect(()=>{const a=H(R.regiones);$(a)},[]),d.useEffect(()=>{const a=J(R.activeUser);if(!a){x({type:"danger",text:"No encontramos tu sesión. Inicia sesión nuevamente."});return}E(a),f(a.avatarUrl??C),v(A(a)),I({}),p({})},[]);const M=d.useMemo(()=>T.find(a=>a.id===s.regionId)?.comunas??[],[T,s.regionId]),O=a=>{const t=a.currentTarget.files?.[0];if(!t)return;const n=new FileReader;n.addEventListener("load",()=>{typeof n.result=="string"&&(f(n.result),v(i=>({...i,avatarUrl:n.result})),p(i=>({...i,avatarUrl:!0})))}),n.readAsDataURL(t)},P=()=>{f(C),v(a=>({...a,avatarUrl:C})),p(a=>({...a,avatarUrl:!0}))},g=a=>{const{name:t,value:n}=a.currentTarget,i=t;let c=n;t==="nombre"||t==="apellidos"?c=se(n):t==="codigoDescuento"&&(c=n.toUpperCase());const m={...s,[i]:c},N={...B,[i]:!0};D(m,N),v(m),p(N),x(null)},b=a=>{const{name:t}=a.currentTarget;if(!t)return;const i={...B,[t]:!0};D(s,i),p(i)},K=a=>{const t=a.currentTarget.value,n={...s,regionId:t,comuna:""},i={...B,regionId:!0,comuna:!0};D(n,i),v(n),p(i),x(null)},G=a=>{const t=a.currentTarget.value,n={...s,comuna:t},i={...B,comuna:!0};D(n,i),v(n),p(i),x(null)},Y=()=>{},_=()=>{},V=()=>{},q=async a=>{if(a.preventDefault(),!u){x({type:"danger",text:"No es posible actualizar el perfil sin sesión activa."});return}if(u.tipoUsuario==="SuperAdmin"){const m=u.run??"",N=s.run??"";if(m!==N){x({type:"danger",text:"La cuenta principal no permite modificar el RUN."});return}}const t=Object.keys(s),n={};t.forEach(m=>{n[m]=!0});const i=D(s,n);if(p(n),!i.isValid){x({type:"danger",text:"Corrige los campos marcados e inténtalo nuevamente."});return}const c=ee({...s,avatarUrl:w,password:s.password||""},u);ae(c),W(R.activeUser,c),E(c),f(c.avatarUrl??C),v(A(c)),I({}),p({}),x({type:"success",text:"Datos actualizados con éxito."}),h(c),F(!0)};return e.jsxs("main",{className:"py-5 bg-light-subtle",children:[z?e.jsx("div",{className:"position-fixed top-0 start-50 translate-middle-x mt-4",style:{zIndex:1055},children:e.jsx("div",{className:"toast show align-items-center text-bg-success border-0",role:"status","aria-live":"assertive",children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:"toast-body",children:[e.jsx("i",{className:"bi bi-check-circle-fill me-2","aria-hidden":"true"})," Cambios guardados con éxito."]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto","aria-label":"Cerrar",onClick:()=>F(!1)})]})})}):null,e.jsx("div",{className:"container",children:e.jsxs("div",{className:"row g-4 g-lg-5",children:[e.jsxs("div",{className:"col-12 col-lg-4",children:[e.jsx("div",{className:"card border-0 shadow-sm",children:e.jsxs("div",{className:"card-body p-4",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("img",{src:w,alt:"Avatar del usuario",className:"rounded-circle mb-3 mx-auto d-block",width:140,height:140,style:{objectFit:"cover"}}),j?e.jsx("span",{className:"badge bg-warning-subtle text-warning-emphasis border border-warning-subtle mb-3",children:"Super administradora"}):null,e.jsxs("div",{className:"d-grid gap-2",children:[e.jsxs("label",{className:`btn btn-outline-secondary${j?" disabled":""}`,htmlFor:j?void 0:"profileAvatarUpload","aria-disabled":j,style:j?{pointerEvents:"none"}:void 0,children:[e.jsx("i",{className:"bi bi-image me-1","aria-hidden":"true"})," Cambiar foto",e.jsx("input",{id:"profileAvatarUpload",type:"file",accept:"image/*",hidden:!0,onChange:O})]}),e.jsxs(U,{type:"button",variant:"mint",onClick:P,disabled:j,children:[e.jsx("i",{className:"bi bi-trash me-1","aria-hidden":"true"})," Quitar foto"]})]})]}),e.jsxs("div",{className:"d-grid gap-2 mt-3",children:[e.jsxs(U,{as:"link",to:"/cart",variant:"mint",children:[e.jsx("i",{className:"bi bi-receipt me-1","aria-hidden":"true"})," Mis pedidos"]}),S?e.jsxs(U,{as:"link",to:S.to,variant:"mint",children:[e.jsx("i",{className:`bi ${S.icon} me-1`,"aria-hidden":"true"})," ",S.label]}):null,e.jsxs(U,{type:"button",variant:"strawberry",onClick:()=>{l(),o("/",{replace:!0})},children:[e.jsx("i",{className:"bi bi-box-arrow-right me-1","aria-hidden":"true"})," Cerrar sesión"]})]})]})}),L.length>0?e.jsx("div",{className:"card border-0 shadow-sm mt-4",children:e.jsxs("div",{className:"card-body p-4",children:[e.jsx("h2",{className:"h6 text-uppercase text-body-secondary fw-semibold mb-3",children:"Beneficios disponibles"}),e.jsx("ul",{className:"list-unstyled mb-0 small",children:L.map(a=>e.jsxs("li",{className:"d-flex align-items-start gap-2 mb-2",children:[e.jsx("i",{className:"bi bi-gift-fill text-success mt-1","aria-hidden":"true"}),e.jsx("span",{children:a.text})]},a.id))})]})}):null]}),e.jsx("div",{className:"col-12 col-lg-8",children:e.jsx("div",{className:"card border-0 shadow-sm mb-4",children:e.jsxs("div",{className:"card-body p-4 p-lg-5",children:[e.jsx("h1",{className:"h4 fw-bold mb-4",children:"Datos personales"}),e.jsxs("form",{className:"row g-3",onSubmit:q,noValidate:!0,children:[k?e.jsx("div",{className:`alert alert-${k.type}`,role:"alert",children:k.text}):null,j?e.jsx("div",{className:"alert alert-warning",role:"status",children:"Esta cuenta superadministradora puede editar su perfil desde aquí excepto su RUN (no modificable)."}):null,e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label fw-semibold",htmlFor:"profileRunBody",children:"RUN"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("input",{type:"text",id:"profileRunBody",name:"runBody",className:`form-control${r.runBody||r.run?" is-invalid":""}`,inputMode:"numeric",pattern:"[0-9]*",placeholder:"19011022",value:s.runBody,onChange:Y,onBlur:V,maxLength:8,style:{flex:1},disabled:!0,readOnly:!0}),e.jsx("span",{className:"fw-semibold","aria-hidden":"true",children:"-"}),e.jsx("input",{type:"text",id:"profileRunDigit",name:"runDigit",className:`form-control${r.runDigit||r.run?" is-invalid":""}`,inputMode:"text",pattern:"[0-9Kk]",placeholder:"K",value:s.runDigit,onChange:_,onBlur:V,maxLength:1,style:{width:"4rem"},disabled:!0,readOnly:!0})]}),r.runBody?e.jsx("div",{className:"invalid-feedback d-block",children:r.runBody}):null,r.runDigit?e.jsx("div",{className:"invalid-feedback d-block",children:r.runDigit}):null,!r.runBody&&!r.runDigit&&r.run?e.jsx("div",{className:"invalid-feedback d-block",children:r.run}):null]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"birthdate",children:"Fecha de nacimiento (opcional)"}),e.jsx("input",{type:"date",id:"birthdate",name:"fechaNacimiento",className:`form-control${r.fechaNacimiento?" is-invalid":""}`,value:s.fechaNacimiento??"",onChange:g,onBlur:b}),r.fechaNacimiento?e.jsx("div",{className:"invalid-feedback d-block",children:r.fechaNacimiento}):null]}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(y,{label:"Nombre",name:"nombre",placeholder:"María",value:s.nombre,onChange:g,onBlur:b,errorText:r.nombre})}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(y,{label:"Apellidos",name:"apellidos",placeholder:"Pérez González",value:s.apellidos,onChange:g,onBlur:b,errorText:r.apellidos})}),e.jsxs("div",{className:"col-12",children:[e.jsx(y,{label:"Correo",name:"correo",type:"email",placeholder:"usuario@dominio.com",value:s.correo,onChange:g,onBlur:b,errorText:r.correo}),e.jsx(y,{label:"Código promocional (opcional)",name:"codigoDescuento",placeholder:"Ej: FELICES50",value:s.codigoDescuento??"",onChange:g,onBlur:b,helperText:"Úsalo para activar beneficios disponibles.",errorText:r.codigoDescuento})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"region",children:"Región"}),e.jsxs("select",{id:"region",className:`form-select${r.regionId?" is-invalid":""}`,value:s.regionId,onChange:K,children:[e.jsx("option",{value:"",children:"Selecciona una región"}),T.map(a=>e.jsx("option",{value:a.id,children:a.region},a.id))]}),r.regionId?e.jsx("div",{className:"invalid-feedback d-block",children:r.regionId}):null]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"comuna",children:"Comuna"}),e.jsxs("select",{id:"comuna",className:`form-select${r.comuna?" is-invalid":""}`,disabled:!s.regionId,value:s.comuna,onChange:G,children:[e.jsx("option",{value:"",children:"Selecciona una comuna"}),M.map(a=>e.jsx("option",{value:a,children:a},a))]}),r.comuna?e.jsx("div",{className:"invalid-feedback d-block",children:r.comuna}):null]}),e.jsx("div",{className:"col-12",children:e.jsx(y,{label:"Dirección",name:"direccion",placeholder:"Calle 123",value:s.direccion,onChange:g,onBlur:b,errorText:r.direccion})}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(y,{label:"Contraseña",name:"password",type:"password",placeholder:"••••",value:s.password,onChange:g,onBlur:b,helperText:"Déjalo en blanco para mantener tu contraseña actual.",errorText:r.password})}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(y,{label:"Confirmar contraseña",name:"confirmPassword",type:"password",placeholder:"••••",value:s.confirmPassword,onChange:g,onBlur:b,errorText:r.confirmPassword})}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mt-4",children:e.jsxs(U,{type:"submit",variant:"strawberry",children:[e.jsx("i",{className:"bi bi-save2 me-1","aria-hidden":"true"})," Guardar cambios"]})})]})]})})})]})})]})};export{ce as default};
