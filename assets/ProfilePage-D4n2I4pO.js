import{a as W,r as u,f as y,g as q,h as H,j as e,c as A,s as J}from"./index-CqkjqQ36.js";import{B as U,I as N}from"./Input-Bel9z8HH.js";import{u as X}from"./useAuth-Ce2KblCh.js";import{v as Z,m as ee,a as ae,s as se}from"./userValidations-BhS8UWS7.js";const re=l=>{const c=l.replace(/[^0-9kK]/g,"").toUpperCase();return c?c.length===1?{body:"",digit:c}:{body:c.slice(0,-1).slice(0,8),digit:c.slice(-1)}:{body:"",digit:""}},E=l=>{const{body:c,digit:p}=re(l?.run??"");return{id:l?.id??"",run:c&&p?`${c}${p}`:"",runBody:c,runDigit:p,nombre:l?.nombre??"",apellidos:l?.apellidos??"",correo:l?.correo??"",fechaNacimiento:l?.fechaNacimiento??"",regionId:l?.regionId??"",comuna:l?.comuna??"",direccion:l?.direccion??"",password:"",confirmPassword:"",termsAccepted:!0,avatarUrl:l?.avatarUrl??y,codigoDescuento:l?.codigoDescuento??""}},ie=l=>{if(!l)return null;const c=new Date(l);if(Number.isNaN(c.getTime()))return null;const p=new Date;let C=p.getFullYear()-c.getFullYear();const v=p.getMonth()-c.getMonth();return(v<0||v===0&&p.getDate()<c.getDate())&&(C-=1),C},ce=()=>{const l=W(),{logout:c,refreshUser:p}=X(),[C,v]=u.useState(y),[T,$]=u.useState([]),[m,R]=u.useState(null),[s,j]=u.useState(E()),[r,I]=u.useState({}),[B,b]=u.useState({}),[k,x]=u.useState(null),n=m?.tipoUsuario==="SuperAdmin",[z,F]=u.useState(!1),L=u.useMemo(()=>{const a=[],o=s.fechaNacimiento||m?.fechaNacimiento,i=ie(o),t=(m?.codigoDescuento??s.codigoDescuento??"").trim().toUpperCase(),h=(s.correo||m?.correo||"").toLowerCase().split("@")[1]??"";return typeof i=="number"&&i>=50&&a.push({id:"senior-discount",text:"Obtienes un 50% de descuento por ser mayor de 50 años."}),t==="FELICES50"&&a.push({id:"felices50",text:"Aplicamos un 10% de descuento gracias al código FELICES50."}),h.endsWith("duoc.cl")&&a.push({id:"duoc-birthday",text:"Tienes derecho a una torta gratis en tu cumpleaños por pertenecer a la comunidad Duoc UC."}),a},[m?.codigoDescuento,m?.correo,m?.fechaNacimiento,s.codigoDescuento,s.correo,s.fechaNacimiento]),w=u.useCallback((a,o,i)=>{const t=i??Z(a,{mode:"update"}),d={};return Object.keys(o).forEach(h=>{if(!o[h])return;const D=t.errors[h];D&&(d[h]=D)}),I(d),t},[I]),S=u.useMemo(()=>{const a=m?.tipoUsuario;return a==="Administrador"||a==="SuperAdmin"?{label:"Ir a la vista de administrador",to:"/admin",icon:"bi-speedometer2"}:a==="Vendedor"?{label:"Ir a la vista de vendedor",to:"/seller",icon:"bi-shop"}:null},[m?.tipoUsuario]);u.useEffect(()=>{const a=q(A.regiones);$(a)},[]),u.useEffect(()=>{const a=H(A.activeUser);if(!a){x({type:"danger",text:"No encontramos tu sesión. Inicia sesión nuevamente."});return}R(a),v(a.avatarUrl??y),j(E(a)),I({}),b({})},[]);const M=u.useMemo(()=>T.find(a=>a.id===s.regionId)?.comunas??[],[T,s.regionId]),O=a=>{if(n)return;const o=a.currentTarget.files?.[0];if(!o)return;const i=new FileReader;i.addEventListener("load",()=>{typeof i.result=="string"&&(v(i.result),j(t=>({...t,avatarUrl:i.result})),b(t=>({...t,avatarUrl:!0})))}),i.readAsDataURL(o)},P=()=>{n||(v(y),j(a=>({...a,avatarUrl:y})),b(a=>({...a,avatarUrl:!0})))},g=a=>{if(n)return;const{name:o,value:i}=a.currentTarget,t=o;let d=i;o==="nombre"||o==="apellidos"?d=se(i):o==="codigoDescuento"&&(d=i.toUpperCase());const h={...s,[t]:d},D={...B,[t]:!0};w(h,D),j(h),b(D),x(null)},f=a=>{if(n)return;const{name:o}=a.currentTarget;if(!o)return;const t={...B,[o]:!0};w(s,t),b(t)},K=a=>{if(n)return;const o=a.currentTarget.value,i={...s,regionId:o,comuna:""},t={...B,regionId:!0,comuna:!0};w(i,t),j(i),b(t),x(null)},G=a=>{if(n)return;const o=a.currentTarget.value,i={...s,comuna:o},t={...B,comuna:!0};w(i,t),j(i),b(t),x(null)},Y=()=>{},_=()=>{},V=()=>{},Q=async a=>{if(a.preventDefault(),!m){x({type:"danger",text:"No es posible actualizar el perfil sin sesión activa."});return}if(m.tipoUsuario==="SuperAdmin"){x({type:"danger",text:"La cuenta principal está protegida y no admite modificaciones."});return}const o=Object.keys(s),i={};o.forEach(h=>{i[h]=!0});const t=w(s,i);if(b(i),!t.isValid){x({type:"danger",text:"Corrige los campos marcados e inténtalo nuevamente."});return}const d=ee({...s,avatarUrl:C,password:s.password||""},m);ae(d),J(A.activeUser,d),R(d),v(d.avatarUrl??y),j(E(d)),I({}),b({}),x({type:"success",text:"Datos actualizados con éxito."}),p(d),F(!0)};return e.jsxs("main",{className:"py-5 bg-light-subtle",children:[z?e.jsx("div",{className:"position-fixed top-0 start-50 translate-middle-x mt-4",style:{zIndex:1055},children:e.jsx("div",{className:"toast show align-items-center text-bg-success border-0",role:"status","aria-live":"assertive",children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:"toast-body",children:[e.jsx("i",{className:"bi bi-check-circle-fill me-2","aria-hidden":"true"})," Cambios guardados con éxito."]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto","aria-label":"Cerrar",onClick:()=>F(!1)})]})})}):null,e.jsx("div",{className:"container",children:e.jsxs("div",{className:"row g-4 g-lg-5",children:[e.jsxs("div",{className:"col-12 col-lg-4",children:[e.jsx("div",{className:"card border-0 shadow-sm",children:e.jsxs("div",{className:"card-body p-4",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("img",{src:C,alt:"Avatar del usuario",className:"rounded-circle mb-3 mx-auto d-block",width:140,height:140,style:{objectFit:"cover"}}),n?e.jsx("span",{className:"badge bg-warning-subtle text-warning-emphasis border border-warning-subtle mb-3",children:"Super administradora"}):null,e.jsxs("div",{className:"d-grid gap-2",children:[e.jsxs("label",{className:`btn btn-outline-secondary${n?" disabled":""}`,htmlFor:n?void 0:"profileAvatarUpload","aria-disabled":n,style:n?{pointerEvents:"none"}:void 0,children:[e.jsx("i",{className:"bi bi-image me-1","aria-hidden":"true"})," Cambiar foto",e.jsx("input",{id:"profileAvatarUpload",type:"file",accept:"image/*",hidden:!0,onChange:O})]}),e.jsxs(U,{type:"button",variant:"mint",onClick:P,disabled:n,children:[e.jsx("i",{className:"bi bi-trash me-1","aria-hidden":"true"})," Quitar foto"]})]})]}),e.jsxs("div",{className:"d-grid gap-2 mt-3",children:[e.jsxs(U,{as:"link",to:"/cart",variant:"mint",children:[e.jsx("i",{className:"bi bi-receipt me-1","aria-hidden":"true"})," Mis pedidos"]}),S?e.jsxs(U,{as:"link",to:S.to,variant:"mint",children:[e.jsx("i",{className:`bi ${S.icon} me-1`,"aria-hidden":"true"})," ",S.label]}):null,e.jsxs(U,{type:"button",variant:"strawberry",onClick:()=>{c(),l("/",{replace:!0})},children:[e.jsx("i",{className:"bi bi-box-arrow-right me-1","aria-hidden":"true"})," Cerrar sesión"]})]})]})}),L.length>0?e.jsx("div",{className:"card border-0 shadow-sm mt-4",children:e.jsxs("div",{className:"card-body p-4",children:[e.jsx("h2",{className:"h6 text-uppercase text-body-secondary fw-semibold mb-3",children:"Beneficios disponibles"}),e.jsx("ul",{className:"list-unstyled mb-0 small",children:L.map(a=>e.jsxs("li",{className:"d-flex align-items-start gap-2 mb-2",children:[e.jsx("i",{className:"bi bi-gift-fill text-success mt-1","aria-hidden":"true"}),e.jsx("span",{children:a.text})]},a.id))})]})}):null]}),e.jsx("div",{className:"col-12 col-lg-8",children:e.jsx("div",{className:"card border-0 shadow-sm mb-4",children:e.jsxs("div",{className:"card-body p-4 p-lg-5",children:[e.jsx("h1",{className:"h4 fw-bold mb-4",children:"Datos personales"}),e.jsxs("form",{className:"row g-3",onSubmit:Q,noValidate:!0,children:[k?e.jsx("div",{className:`alert alert-${k.type}`,role:"alert",children:k.text}):null,n?e.jsx("div",{className:"alert alert-warning",role:"status",children:"Esta cuenta superadministradora está protegida. No es posible editar sus datos desde esta vista."}):null,e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label fw-semibold",htmlFor:"profileRunBody",children:"RUN"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("input",{type:"text",id:"profileRunBody",name:"runBody",className:`form-control${r.runBody||r.run?" is-invalid":""}`,inputMode:"numeric",pattern:"[0-9]*",placeholder:"19011022",value:s.runBody,onChange:Y,onBlur:V,maxLength:8,style:{flex:1},disabled:!0,readOnly:!0}),e.jsx("span",{className:"fw-semibold","aria-hidden":"true",children:"-"}),e.jsx("input",{type:"text",id:"profileRunDigit",name:"runDigit",className:`form-control${r.runDigit||r.run?" is-invalid":""}`,inputMode:"text",pattern:"[0-9Kk]",placeholder:"K",value:s.runDigit,onChange:_,onBlur:V,maxLength:1,style:{width:"4rem"},disabled:!0,readOnly:!0})]}),r.runBody?e.jsx("div",{className:"invalid-feedback d-block",children:r.runBody}):null,r.runDigit?e.jsx("div",{className:"invalid-feedback d-block",children:r.runDigit}):null,!r.runBody&&!r.runDigit&&r.run?e.jsx("div",{className:"invalid-feedback d-block",children:r.run}):null]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"birthdate",children:"Fecha de nacimiento (opcional)"}),e.jsx("input",{type:"date",id:"birthdate",name:"fechaNacimiento",className:`form-control${r.fechaNacimiento?" is-invalid":""}`,value:s.fechaNacimiento??"",onChange:g,onBlur:f,disabled:n}),r.fechaNacimiento?e.jsx("div",{className:"invalid-feedback d-block",children:r.fechaNacimiento}):null]}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(N,{label:"Nombre",name:"nombre",placeholder:"María",value:s.nombre,onChange:g,onBlur:f,errorText:r.nombre,disabled:n})}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(N,{label:"Apellidos",name:"apellidos",placeholder:"Pérez González",value:s.apellidos,onChange:g,onBlur:f,errorText:r.apellidos,disabled:n})}),e.jsxs("div",{className:"col-12",children:[e.jsx(N,{label:"Correo",name:"correo",type:"email",placeholder:"usuario@dominio.com",value:s.correo,onChange:g,onBlur:f,errorText:r.correo,disabled:n}),e.jsx(N,{label:"Código promocional (opcional)",name:"codigoDescuento",placeholder:"Ej: FELICES50",value:s.codigoDescuento??"",onChange:g,onBlur:f,helperText:"Úsalo para activar beneficios disponibles.",errorText:r.codigoDescuento,disabled:n})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"region",children:"Región"}),e.jsxs("select",{id:"region",className:`form-select${r.regionId?" is-invalid":""}`,value:s.regionId,onChange:K,disabled:n,children:[e.jsx("option",{value:"",children:"Selecciona una región"}),T.map(a=>e.jsx("option",{value:a.id,children:a.region},a.id))]}),r.regionId?e.jsx("div",{className:"invalid-feedback d-block",children:r.regionId}):null]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"comuna",children:"Comuna"}),e.jsxs("select",{id:"comuna",className:`form-select${r.comuna?" is-invalid":""}`,disabled:n||!s.regionId,value:s.comuna,onChange:G,children:[e.jsx("option",{value:"",children:"Selecciona una comuna"}),M.map(a=>e.jsx("option",{value:a,children:a},a))]}),r.comuna?e.jsx("div",{className:"invalid-feedback d-block",children:r.comuna}):null]}),e.jsx("div",{className:"col-12",children:e.jsx(N,{label:"Dirección",name:"direccion",placeholder:"Calle 123",value:s.direccion,onChange:g,onBlur:f,errorText:r.direccion,disabled:n})}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(N,{label:"Contraseña",name:"password",type:"password",placeholder:"••••",value:s.password,onChange:g,onBlur:f,helperText:"Déjalo en blanco para mantener tu contraseña actual.",errorText:r.password,disabled:n})}),e.jsx("div",{className:"col-12 col-md-6",children:e.jsx(N,{label:"Confirmar contraseña",name:"confirmPassword",type:"password",placeholder:"••••",value:s.confirmPassword,onChange:g,onBlur:f,errorText:r.confirmPassword,disabled:n})}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mt-4",children:e.jsxs(U,{type:"submit",variant:"strawberry",disabled:n,children:[e.jsx("i",{className:"bi bi-save2 me-1","aria-hidden":"true"})," Guardar cambios"]})})]})]})})})]})})]})};export{ce as default};
